import{u as w}from"./app-store-BeK8FA_5.js";import{al as m,r as c,o as g,b as S}from"./index-CkHtFk-G.js";import{a as M}from"./printengine-store-eb6PD6y-.js";const y=()=>{const a=w(),{ws:e,wsMessageHandlers:s}=m(a),d=c("127.0.0.1"),v=c(2e3);return g(()=>{if(e.value===void 0&&(e.value=new WebSocket(`ws://${d.value}:4649/TcpToWs`),setTimeout(o=>{if(o.value!==void 0&&o.value.readyState!==o.value.OPEN)throw o.value=void 0,new Error("Connection to WS server timed out")},v.value,e)),e.value===void 0)throw new Error("No WebSocket object");e.value.onclose=()=>{console.log("disconnected")},e.value.onmessage=o=>{const r=JSON.parse(o.data.toString());"error"in r&&console.error(r.error),"log"in r&&console.log(r.log);for(const i in s.value){const u=s.value[i];if(u===void 0)return;u(r)}},e.value.onopen=()=>{console.log("connected")}}),{ws:e,registerMessageHandler:(o,r)=>{s.value[o]=r},unregisterMessageHandler:o=>{delete s.value[o]},close:()=>{e.value instanceof WebSocket&&e.value.close()},wsMessageHandlers:s}},E=a=>{const{ws:e,wsMessageHandlers:s,registerMessageHandler:d,unregisterMessageHandler:v}=y();if(s.value[a.value.IpAddr]!==void 0)throw new Error("Board is already monitored");const t=c([]),l=c(""),p=async()=>{const{ExecuteCmd:n}=await M();await n("TcpForwarder",{CmdType:"CmdConfigTcpTunnel",TargetEndPoint:`${a.value.IpAddr}:777`}),i(),d(a.value.IpAddr,r)},o=async()=>{i(),v(a.value.IpAddr)},r=n=>{"data"in n&&n.data&&"board"in n&&n.board===a.value.IpAddr&&(l.value=n.data,u())},i=async()=>{if(e.value===void 0)throw new Error("WS is not available");e.value.send(JSON.stringify({board:a.value.IpAddr}))},u=()=>{t.value=t.value.map(n=>{const f=n.regex.exec(l.value)||n.results;return{...n,results:f}})};return g(()=>{p()}),S(()=>{o()}),{page:l,regexList:t}};export{E as u};
