import{A}from"./index-BAU4s81U.js";import{r as t,c as m,al as R,aj as k}from"./index-CkHtFk-G.js";import{api as v}from"./axios-DjX7m9jH.js";import{u as S}from"./app-store-BeK8FA_5.js";const b=()=>{const s=t(),u=t(!0),c=t(),d=t(0),a=t(),l=t([{name:"DPU",ip:"172.17.5.90",user:"Admin",password:"Admin"},{name:"Machine",ip:"172.17.5.192",user:"Admin",password:"claudio"}]),w=S(),p=m(()=>`https://${s.value}`),f=m(()=>{const{proxy:r}=R(w);return`${u.value?`http://${r.value.host}:${r.value.port}`:p}/api/jsonrpc`}),n=async r=>{if(s.value===void 0)throw new Error("Server IP is not defined");r=Array.isArray(r)?r:[r],r=r.map(e=>({...e,jsonrpc:"2.0",id:P()}));try{u.value&&(v.defaults.headers.common.Target=p.value);const e=(await v.post(f.value,r,{headers:{"X-Auth-Token":c.value}})).data[0];if(e===void 0)throw new Error("Empty result");if(e.error!==void 0&&e.error.code===2){const o=await n({method:"Api.Login",params:{...y()}});if(typeof o?.token!="string")throw new Error("Can't get auth token",{cause:o});c.value=o.token;const i=await n(r);if(i==null)throw new Error("Request result is null or undefined");e.result=i}if(e.error!==void 0&&e.error.code!==2)throw new Error("PLC answered with error",{cause:e.error});if(e.result===void 0)throw new Error("Request result is not defined");return a.value=void 0,e.result}catch(e){const o=e instanceof Error?e.cause:"Unknown";k.create({message:"Failed to send request to PLC",html:!0,caption:`<pre>${e}
${JSON.stringify(o)}</pre>`}),e instanceof A&&e.code==="ERR_NETWORK"&&(a.value="Network error");return}},h=r=>{r=Array.isArray(r)?r:[r];const e=r.map(o=>({method:"PlcProgram.Read",params:{var:o}}));return n(e)},g=r=>n({method:"PlcProgram.Browse",params:{...r===void 0?{}:{var:r},mode:"children"}}),E=(r,e)=>{if(typeof r!="string")throw new Error("Path is not a string");return n({method:"PlcProgram.Write",params:{var:r,value:e}})},y=()=>{if(s.value===void 0)throw new Error("Server is not defined");const r=l.value.filter(e=>e.ip===s.value);if(r[0]===void 0)throw new Error("Failed to get server credentials");return{user:r[0].user,password:r[0].password}},P=()=>(d.value++,d.value);return{read:h,browse:g,write:E,ip:s,servers:l,error:a}};export{b as u};
